name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  e2e-test:
    name: Build & E2E Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"

      - name: Lint Backend
        uses: golangci/golangci-lint-action@v6
        with:
          version: latest
          working-directory: backend
          args: --timeout=5m

      - name: Install Helm
        uses: azure/setup-helm@v4

      - name: Create Kind Cluster
        uses: helm/kind-action@v1
        with:
          cluster_name: kind

      - name: Install Ingress NGINX
        run: |
          helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
          helm repo update
          helm install ingress-nginx ingress-nginx/ingress-nginx \
            --namespace ingress-nginx --create-namespace \
            --wait --timeout 5m

      - name: Prepare Operator Build Context
        run: |
          # Download the bitnami/wordpress subchart
          helm dependency build charts/engine-woo

          mkdir -p operator/charts/engine-woo
          cp -r charts/engine-woo/* operator/charts/engine-woo/
          ls -R operator/charts/

      - name: Build Docker Images
        run: |
          docker build -t store-backend:v1 backend/
          docker build -t store-operator:v1 operator/

      - name: Load Images into Kind
        run: |
          kind load docker-image store-backend:v1
          kind load docker-image store-operator:v1

      - name: Deploy Platform
        run: |
          kubectl apply -f deploy/crds/
          kubectl apply -f deploy/redis/
          kubectl apply -f deploy/backend/
          kubectl apply -f deploy/operator/

          echo "Waiting for pods..."
          kubectl wait --for=condition=ready pod -l app=redis --timeout=120s
          kubectl wait --for=condition=ready pod -l app=store-backend --timeout=120s
          kubectl wait --for=condition=ready pod -l app=store-operator --timeout=120s

          kubectl get pods -A

      - name: Run E2E Tests
        run: |
          # Forward the ingress controller so nip.io hostnames resolve
          kubectl port-forward svc/ingress-nginx-controller -n ingress-nginx 8080:80 &
          # Give it a moment to connect
          sleep 10
          chmod +x test/e2e.sh
          
          # Run the test. If it fails, run the logging commands.
          if ./test/e2e.sh; then
            echo "✅ E2E Test Passed"
          else
            echo "❌ E2E Test Failed - Dumping Logs for Debugging..."
            
            echo "::group::Operator Logs (Why did it fail?)"
            kubectl logs -l app=store-operator --tail=200
            echo "::endgroup::"
            
            echo "::group::Backend Logs"
            kubectl logs -l app=store-backend --tail=100
            echo "::endgroup::"
            
            echo "::group::Store Status Object"
            kubectl get stores -o yaml
            echo "::endgroup::"
            
            # Ensure the pipeline actually fails
            exit 1
          fi