name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  packages: write

jobs:
  e2e-test:
    name: Build & E2E Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"

      - name: Lint Backend
        uses: golangci/golangci-lint-action@v6
        with:
          version: latest
          working-directory: backend
          args: --timeout=5m

      - name: Install Helm
        uses: azure/setup-helm@v4

      - name: Create Kind Cluster
        uses: helm/kind-action@v1
        with:
          cluster_name: kind

      - name: Install Ingress NGINX
        run: |
          helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
          helm repo update
          helm install ingress-nginx ingress-nginx/ingress-nginx \
            --namespace ingress-nginx --create-namespace \
            --wait --timeout 5m

      - name: Prepare Operator Build Context
        run: |
          helm repo add bitnami https://charts.bitnami.com/bitnami
          # This downloads the dependencies (WordPress) into charts/engine-woo/charts/
          helm dependency build charts/engine-woo

          # Copy to Operator context (for the local Docker build)
          mkdir -p operator/charts/engine-woo
          cp -r charts/engine-woo/* operator/charts/engine-woo/
          ls -R operator/charts/

      - name: Publish Helm Charts to GHCR
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          # OCI requires lowercase repository names. 
          # We convert the owner (e.g., Jovial-Kanwadia) to lowercase (jovial-kanwadia).
          OWNER_LC=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')

          # 1. Login to GitHub Container Registry
          echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ghcr.io -u ${{ github.actor }} --password-stdin

          # 2. Package the Chart
          # (Dependencies were already built in the previous step)
          helm package charts/engine-woo --destination .cr-release-packages

          # 3. Push to GHCR
          for pkg in .cr-release-packages/*.tgz; do
            if [ -z "${pkg}" ]; then continue; fi
            echo "Pushing ${pkg} to oci://ghcr.io/${OWNER_LC}/charts"
            helm push "${pkg}" oci://ghcr.io/${OWNER_LC}/charts
          done
          cp .cr-release-packages/engine-woo-*.tgz operator/

      - name: Build Docker Images
        run: |
          docker build -t store-backend:v1 backend/
          docker build -t store-operator:v1 operator/

      - name: Load Images into Kind
        run: |
          kind load docker-image store-backend:v1
          kind load docker-image store-operator:v1

      - name: Deploy Platform
        run: |
          kubectl apply -f deploy/crds/
          kubectl apply -f deploy/redis/
          kubectl apply -f deploy/backend/
          kubectl apply -f deploy/operator/

          echo "Waiting for pods..."
          kubectl wait --for=condition=ready pod -l app=redis --timeout=120s
          kubectl wait --for=condition=ready pod -l app=store-backend --timeout=120s
          kubectl wait --for=condition=ready pod -l app=store-operator --timeout=120s

          kubectl get pods -A

      - name: Run E2E Tests
        run: |
          # Forward the ingress controller so nip.io hostnames resolve
          kubectl port-forward svc/store-backend 8080:80 &
          kubectl port-forward -n ingress-nginx svc/ingress-nginx-controller 8081:80 &
          # Give it a moment to connect
          sleep 10
          chmod +x test/e2e.sh
          
          # Run the test. If it fails, run the logging commands.
          if ./test/e2e.sh; then
            echo "✅ E2E Test Passed"
          else
            echo "❌ E2E Test Failed - Dumping Logs for Debugging..."
            
            echo "::group::Operator Logs (Why did it fail?)"
            kubectl logs -l app=store-operator --tail=200
            echo "::endgroup::"
            
            echo "::group::Backend Logs"
            kubectl logs -l app=store-backend --tail=100
            echo "::endgroup::"
            
            echo "::group::Store Status Object"
            kubectl get stores -o yaml
            echo "::endgroup::"
            
            # Ensure the pipeline actually fails
            exit 1
          fi