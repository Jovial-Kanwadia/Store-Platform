name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  e2e-test:
    name: Build & E2E Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"

      - name: Lint Backend
        uses: golangci/golangci-lint-action@v6
        with:
          version: latest
          working-directory: backend
          args: --timeout=5m

      - name: Create Kind Cluster
        uses: helm/kind-action@v1
        with:
          cluster_name: kind

      - name: Prepare Operator Build Context
        run: |
          echo "Current directory: $(pwd)"
          ls -R charts/

          # Create the destination directory inside operator
          mkdir -p operator/charts/engine-woo

          # Copy the engine-woo chart (which is your WordPress chart) 
          # to where the operator expects it
          if [ -d "charts/engine-woo" ]; then
            echo "Copying engine-woo to operator/charts/wordpress..."
            cp -r charts/engine-woo/* operator/charts/engine-woo/
          else
            echo "::error::charts/engine-woo not found at root!"
            exit 1
          fi
          
          # Verify the copy worked
          ls -R operator/charts/

      - name: Build Docker Images
        run: |
          docker build -t store-backend:v1 backend/
          docker build -t store-operator:v1 operator/

      - name: Load Images into Kind
        run: |
          kind load docker-image store-backend:v1
          kind load docker-image store-operator:v1

      - name: Deploy Platform
        run: |
          kubectl apply -f deploy/crds/
          kubectl apply -f deploy/redis/
          kubectl apply -f deploy/backend/
          kubectl apply -f deploy/operator/

          echo "Waiting for pods..."
          kubectl wait --for=condition=ready pod -l app=redis --timeout=120s
          kubectl wait --for=condition=ready pod -l app=store-backend --timeout=120s
          kubectl wait --for=condition=ready pod -l app=store-operator --timeout=120s

          kubectl get pods -A

      - name: Run E2E Tests
        run: |
          # Start the tunnel in the background
          kubectl port-forward svc/store-backend 8080:80 &
          # Give it a moment to connect
          sleep 5
          chmod +x test/e2e.sh
          
          # Run the test. If it fails, run the logging commands.
          if ./test/e2e.sh; then
            echo "✅ E2E Test Passed"
          else
            echo "❌ E2E Test Failed - Dumping Logs for Debugging..."
            
            echo "::group::Operator Logs (Why did it fail?)"
            kubectl logs -l app=store-operator --tail=200
            echo "::endgroup::"
            
            echo "::group::Backend Logs"
            kubectl logs -l app=store-backend --tail=100
            echo "::endgroup::"
            
            echo "::group::Store Status Object"
            kubectl get stores -o yaml
            echo "::endgroup::"
            
            # Ensure the pipeline actually fails
            exit 1
          fi