name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  packages: write

jobs:
  e2e-test:
    name: Build & E2E Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"

      - name: Lint Backend
        uses: golangci/golangci-lint-action@v6
        with:
          version: latest
          working-directory: backend
          args: --timeout=5m

      - name: Install Helm
        uses: azure/setup-helm@v4

      - name: Create Kind Cluster
        uses: helm/kind-action@v1
        with:
          cluster_name: kind

      - name: Install Ingress NGINX
        run: |
          helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
          helm repo update
          helm install ingress-nginx ingress-nginx/ingress-nginx \
            --namespace ingress-nginx --create-namespace \
            --wait --timeout 5m

      - name: Prepare Operator Build Context
        run: |
          # 1. Add repositories needed for dependencies
          helm repo add bitnami https://charts.bitnami.com/bitnami
          
          # 2. Build dependencies (Downloads WordPress tgz into charts/engine-woo/charts/)
          helm dependency build charts/engine-woo

          # 3. Create the build context directory
          mkdir -p operator/charts/engine-woo

          # 4. Copy the fully hydrated chart (with dependencies) to the operator build folder
          cp -r charts/engine-woo/* operator/charts/engine-woo/
          
          # Debug: Prove the files are there for Docker
          ls -R operator/charts/

      - name: Build Docker Images
        run: |
          # The Dockerfile will now find 'charts/engine-woo' in its context
          docker build -t store-backend:v1 backend/
          docker build -t store-operator:v1 operator/

      - name: Load Images into Kind
        run: |
          kind load docker-image store-backend:v1
          kind load docker-image store-operator:v1

      - name: Deploy Platform
        run: |
          kubectl apply -f deploy/crds/
          kubectl apply -f deploy/redis/
          kubectl apply -f deploy/backend/
          kubectl apply -f deploy/operator/

          echo "Waiting for critical pods..."
          kubectl wait --for=condition=ready pod -l app=redis --timeout=120s
          kubectl wait --for=condition=ready pod -l app=store-backend --timeout=120s
          kubectl wait --for=condition=ready pod -l app=store-operator --timeout=120s

          kubectl get pods -A

      - name: Run E2E Tests
        run: |
          # Forward Backend API (8080) and Ingress (8081)
          kubectl port-forward svc/store-backend 8080:80 &
          kubectl port-forward -n ingress-nginx svc/ingress-nginx-controller 8081:80 &
          
          # Wait for tunnels to establish
          sleep 5
          chmod +x test/e2e.sh
          
          # Run the robust test script
          if ./test/e2e.sh; then
            echo "✅ E2E Test Passed"
          else
            echo "❌ E2E Test Failed - Dumping Debug Logs..."
            
            echo "::group::Operator Logs"
            kubectl logs -l app=store-operator --tail=200
            echo "::endgroup::"
            
            echo "::group::Backend Logs"
            kubectl logs -l app=store-backend --tail=100
            echo "::endgroup::"
            
            echo "::group::Store Status"
            kubectl get stores -o yaml
            echo "::endgroup::"
            
            exit 1
          fi

      # MOVED TO END: Only publish if tests pass!
      - name: Publish Helm Charts to GHCR
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          OWNER_LC=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ghcr.io -u ${{ github.actor }} --password-stdin

          # Package the chart (using the source which already has dependencies built)
          helm package charts/engine-woo --destination .cr-release-packages

          # Push to OCI Registry
          for pkg in .cr-release-packages/*.tgz; do
            if [ -z "${pkg}" ]; then continue; fi
            echo "Pushing ${pkg} to oci://ghcr.io/${OWNER_LC}/charts"
            helm push "${pkg}" oci://ghcr.io/${OWNER_LC}/charts
          done